{{- if and (eq .Values.installationMode "OEA-AP") (.Values.installArgoCD) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: oea-carina-autoconfigure
  labels:
{{ include "oea.standard-labels" . | indent 4 }}
data:
  datasource-api.sh: |-
    #!/bin/bash
    set -x
    ## install argoCLI
    curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
    chmod +x /usr/local/bin/argocd
    sleep 60
    ## get the user password
    argopassword=$(kubectl get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d)
    ## argocli login
    argocd login {{ .Values.global.argocd.host }} --username=admin --password=$argopassword --grpc-web
    token=$(argocd account generate-token)
    encodedtoken=$(echo -n $token | base64 -w0)
    ## replace the secret
    kubectl get secret oea-carina-config -o jsonpath='{.data.*}' | base64 -d > carina-secret.yaml
    yq e '.argos.[].token = "'$encodedtoken'"' carina-secret.yaml > carina-manager.yaml
    kubectl delete secret oea-carina-config
    kubectl create secret generic oea-carina-config  --from-file=carina-manager.yaml
{{- end -}}
